import{r as S}from"./react-vendor-BdF-CjAN.js";const U={audible:{mode:"audible",startFrequency:200,endFrequency:18e3,duration:.5,fadeTime:.01},ultrasonic:{mode:"ultrasonic",startFrequency:15e3,endFrequency:2e4,duration:.3,fadeTime:.005}},G={sampleRate:48e3,duration:2,preDelay:.1},I=60;function H(t){const{startFrequency:e,endFrequency:n,duration:r,sampleRate:o,fadeTime:c}=t,a=Math.floor(r*o),s=new Float32Array(a),l=Math.log(n/e);for(let u=0;u<a;u++){const f=u/o/r,d=2*Math.PI*e*r/l*(Math.exp(l*f)-1);s[u]=Math.sin(d)}return Q(s,o,c),s}function Q(t,e,n){const r=Math.floor(n*e);for(let o=0;o<r&&o<t.length;o++){const c=.5*(1-Math.cos(Math.PI*o/r));t[o]*=c}for(let o=0;o<r&&o<t.length;o++){const c=t.length-1-o,a=.5*(1-Math.cos(Math.PI*o/r));t[c]*=a}}function _(t,e=48e3){return{...U[t],sampleRate:e}}function W(t,e){const n=_(e,t.sampleRate),r=H(n),o=t.createBuffer(1,r.length,t.sampleRate);return o.copyToChannel(new Float32Array(r),0),o}function Y(t,e,n=.8){return new Promise(r=>{const o=W(t,e),c=t.createBufferSource(),a=t.createGain();c.buffer=o,a.gain.value=n,c.connect(a),a.connect(t.destination),c.onended=()=>{const s=new Float32Array(o.length);o.copyFromChannel(s,0),r(s)},c.start()})}let F=null;async function v(){return F||(F=new AudioContext({sampleRate:48e3})),F.state==="suspended"&&await F.resume(),F}function Z(){F&&(F.close(),F=null)}async function C(){try{return await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,sampleRate:48e3}})}catch(t){if(t instanceof Error){if(t.name==="NotAllowedError")throw new Error("Microphone permission denied. Please allow microphone access to use this feature.");if(t.name==="NotFoundError")throw new Error("No microphone found. Please connect a microphone and try again.")}throw t}}async function X(){try{return(await navigator.permissions.query({name:"microphone"})).state==="granted"}catch{try{return(await C()).getTracks().forEach(e=>e.stop()),!0}catch{return!1}}}async function J(t,e,n){const r=await v(),o=r.createMediaStreamSource(t),c=Math.ceil(e*n),a=new Float32Array(c);let s=0;const u=r.createScriptProcessor(4096,1,1);return new Promise(i=>{const f=setTimeout(()=>{d(),i(a)},e*1e3+100);u.onaudioprocess=p=>{const m=p.inputBuffer.getChannelData(0),g=c-s;if(g<=0){d(),i(a);return}const M=Math.min(m.length,g);a.set(m.subarray(0,M),s),s+=M};function d(){clearTimeout(f),u.disconnect(),o.disconnect()}o.connect(u),u.connect(r.destination)})}async function K(t,e=G,n=.8){const r=await v(),o=await C();try{const c=_(t,r.sampleRate),a=c.duration,l=e.preDelay+a+1.5,u=J(o,l,r.sampleRate);await tt(e.preDelay*1e3);const i=await Y(r,t,n);return{captured:await u,chirp:i,sampleRate:r.sampleRate,config:c,timestamp:Date.now()}}finally{o.getTracks().forEach(c=>c.stop())}}async function $(t,e){const n=await v(),r=n.createMediaStreamSource(t),o=n.createAnalyser();o.fftSize=256,r.connect(o);const c=new Float32Array(o.fftSize);let a;function s(){o.getFloatTimeDomainData(c);let l=0;for(let f=0;f<c.length;f++)l+=c[f]*c[f];const u=Math.sqrt(l/c.length),i=Math.min(1,u*5);e(i),a=requestAnimationFrame(s)}return s(),()=>{cancelAnimationFrame(a),r.disconnect(),o.disconnect()}}function tt(t){return new Promise(e=>setTimeout(e,t))}function N(t){return Math.pow(2,Math.ceil(Math.log2(t)))}function P(t,e){if(t.length>=e)return t.slice(0,e);const n=new Float32Array(e);return n.set(t),n}function et(t){const e=new Float32Array(t);for(let n=0;n<t;n++)e[n]=.5*(1-Math.cos(2*Math.PI*n/(t-1)));return e}function nt(t,e){const n=new Float32Array(t.length),r=Math.min(t.length,e.length);for(let o=0;o<r;o++)n[o]=t[o]*e[o];return n}function L(t,e){return{re:t.re*e.re-t.im*e.im,im:t.re*e.im+t.im*e.re}}function ot(t,e){return{re:t.re+e.re,im:t.im+e.im}}function rt(t,e){return{re:t.re-e.re,im:t.im-e.im}}function R(t){return{re:t.re,im:-t.im}}function B(t){return t.re*t.re+t.im*t.im}function k(t){const e=t.length;if(e<=1)return t.slice();if(e&e-1)throw new Error("FFT input length must be a power of 2");const n=new Array(e),r=Math.log2(e);for(let o=0;o<e;o++){let c=0;for(let a=0;a<r;a++)c=c<<1|o>>a&1;n[c]={...t[o]}}for(let o=2;o<=e;o*=2){const c=o/2,a=-2*Math.PI/o;for(let s=0;s<e;s+=o)for(let l=0;l<c;l++){const u={re:Math.cos(a*l),im:Math.sin(a*l)},i=n[s+l],f=L(u,n[s+l+c]);n[s+l]=ot(i,f),n[s+l+c]=rt(i,f)}}return n}function ct(t){const e=t.length,n=t.map(R);return k(n).map(o=>({re:o.re/e,im:-o.im/e}))}function E(t){const e=N(t.length),n=P(t,e),r=Array.from(n,o=>({re:o,im:0}));return k(r)}function at(t){const e=ct(t);return new Float32Array(e.map(n=>n.re))}function b(t){const e=t.length,n=new Float32Array(e/2+1);for(let r=0;r<=e/2;r++)n[r]=B(t[r])/e;return n}function D(t,e=1){return 20*Math.log10(Math.max(t,1e-10)/e)}function st(t){const e=Math.max(...t.map(Math.abs));if(e===0)return t;const n=new Float32Array(t.length);for(let r=0;r<t.length;r++)n[r]=t[r]/e;return n}function lt(t,e,n,r=0,o){o=o??n/2;const c=m=>2595*Math.log10(1+m/700),a=m=>700*(Math.pow(10,m/2595)-1),s=c(r),l=c(o),u=new Float32Array(t+2);for(let m=0;m<t+2;m++)u[m]=s+m*(l-s)/(t+1);const f=u.map(a).map(m=>Math.floor((e+1)*m/n)),d=[],p=e/2+1;for(let m=0;m<t;m++){const g=new Float32Array(p),M=f[m],w=f[m+1],y=f[m+2];for(let h=M;h<w;h++)g[h]=(h-M)/(w-M);for(let h=w;h<y;h++)g[h]=(y-h)/(y-w);d.push(g)}return d}function it(t,e){const n=t.length;e=e??n;const r=new Float32Array(e);for(let o=0;o<e;o++){let c=0;for(let a=0;a<n;a++)c+=t[a]*Math.cos(Math.PI*o*(2*a+1)/(2*n));r[o]=c*Math.sqrt(2/n)}return r[0]*=Math.SQRT1_2,r}function ut(t,e,n){const r=[];let o=0;for(;o+e<=t.length;)r.push(t.slice(o,o+e)),o+=n;return r}function z(t){if(t.length===0)return 0;let e=0;for(let n=0;n<t.length;n++)e+=t[n];return e/t.length}function ft(t){if(t.length===0)return 0;const e=z(t);let n=0;for(let r=0;r<t.length;r++){const o=t[r]-e;n+=o*o}return n/t.length}const ht=.001;function mt(t){const{captured:e,chirp:n,sampleRate:r,config:o}=t,c=pt(e,n,o,ht),a=dt(c,r);return{data:a,sampleRate:r,duration:a.length/r}}function pt(t,e,n,r){const o=t.length+e.length-1,c=N(o),a=P(t,c),s=P(e,c),l=E(a),u=E(s),i=new Array(l.length);for(let p=0;p<l.length;p++){const m=R(u[p]),g=L(l[p],m),M=B(u[p])+r;i[p]={re:g.re/M,im:g.im/M}}const f=new Array(c);for(let p=0;p<c;p++)if(p<i.length)f[p]=i[p];else{const m=c-p;f[p]=R(i[m])}const d=at(f);return st(d)}function dt(t,e){const n=Math.floor(2.5*e);let r=0,o=0;for(let i=0;i<t.length;i++){const f=Math.abs(t[i]);f>o&&(o=f,r=i)}const c=Math.max(0,r-Math.floor(.001*e)),a=o*.001;let s=Math.min(t.length,c+n);const l=Math.floor(.05*e);for(let i=c+l;i<s-l;i++){let f=0;for(let d=0;d<l;d++)f+=t[i+d]*t[i+d];if(f=Math.sqrt(f/l),f<a){s=i+l;break}}const u=Math.floor(.1*e);return s-c<u&&(s=Math.min(t.length,c+u)),t.slice(c,s)}function O(t){const e=t.length,n=new Float32Array(e),r=new Float32Array(e);for(let a=0;a<e;a++)r[a]=t[a]*t[a];let o=0;for(let a=e-1;a>=0;a--)o+=r[a],n[a]=o;const c=n[0];if(c>0)for(let a=0;a<e;a++)n[a]/=c;return n}function j(t){const e=new Float32Array(t.length);for(let n=0;n<t.length;n++)e[n]=10*Math.log10(Math.max(t[n],1e-10));return e}function x(t,e,n){for(let r=0;r<t.length;r++)if(t[r]<n)return r/e;return t.length/e}function gt(t,e){const n=O(t),r=j(n),o=x(r,e,-5),a=2*(x(r,e,-35)-o);return Math.max(.1,Math.min(5,a))}function Mt(t,e){const n=O(t),r=j(n),c=x(r,e,-10)*6;return Math.max(.05,Math.min(3,c))}const A=13,T=26,wt=25,yt=10,Ft=8,St=10,Et=[125,250,500,1e3,2e3,4e3,8e3];function At(t){const{data:e,sampleRate:n}=t,r=gt(e,n),o=Mt(e,n),c=q(e,n,.05),a=q(e,n,.08),s=Ct(e,n),{mfccMean:l,mfccVariance:u}=Tt(e,n),i=Pt(e,n),f=Rt(e,n),d=xt({rt60:r,edt:o,c50:c,c80:a,...s,mfccMean:l,mfccVariance:u,earlyReflections:i,octaveBands:f});return{rt60:r,edt:o,c50:c,c80:a,...s,mfccMean:l,mfccVariance:u,earlyReflections:i,octaveBands:f,raw:d}}function q(t,e,n){const r=Math.floor(n*e);let o=0,c=0;for(let a=0;a<t.length;a++){const s=t[a]*t[a];a<r?o+=s:c+=s}return c<1e-10?20:10*Math.log10(o/c)}function Ct(t,e){const n=E(t),r=b(n),o=e/(n.length*2);let c=0,a=0;for(let h=0;h<r.length;h++){const V=h*o;c+=V*r[h],a+=r[h]}const s=a>0?c/a:0,l=.85*a;let u=0,i=0;for(let h=0;h<r.length;h++)if(u+=r[h],u>=l){i=h*o;break}let f=0;for(let h=0;h<r.length;h++)f+=r[h];const d=Math.sqrt(f);let p=0,m=0,g=0;for(let h=1;h<r.length;h++)r[h]>1e-10&&(p+=Math.log(r[h]),m+=r[h],g++);const M=g>0?Math.exp(p/g):0,w=g>0?m/g:0,y=w>0?M/w:0;return{spectralCentroid:s,spectralRolloff:i,spectralFlux:d,spectralFlatness:y}}function Tt(t,e){const n=Math.floor(wt/1e3*e),r=Math.floor(yt/1e3*e),o=ut(t,n,r);if(o.length===0)return{mfccMean:new Array(A).fill(0),mfccVariance:new Array(A).fill(0)};const c=et(n),a=lt(T,n,e,0,e/2),s=[];for(const i of o){const f=nt(i,c),d=E(f),p=b(d),m=new Float32Array(T);for(let M=0;M<T;M++){let w=0;for(let y=0;y<Math.min(p.length,a[M].length);y++)w+=p[y]*a[M][y];m[M]=Math.log(Math.max(w,1e-10))}const g=it(m,A);s.push(Array.from(g))}const l=[],u=[];for(let i=0;i<A;i++){const f=s.map(d=>d[i]);l.push(z(f)),u.push(ft(f))}return{mfccMean:l,mfccVariance:u}}function Pt(t,e){const n=[],r=Math.floor(St/1e3*e);for(let c=0;c<Ft;c++){const a=c*r,s=Math.min((c+1)*r,t.length);let l=0;for(let u=a;u<s;u++)l+=t[u]*t[u];n.push(l)}const o=Math.max(n[0],1e-10);return n.map(c=>D(Math.sqrt(c/o)))}function Rt(t,e){const n=E(t),r=b(n),o=e/(n.length*2),c=[];for(const s of Et){const l=s/Math.SQRT2,u=s*Math.SQRT2,i=Math.floor(l/o),f=Math.min(Math.ceil(u/o),r.length-1);let d=0;for(let p=i;p<=f;p++)d+=r[p];c.push(d)}const a=c.reduce((s,l)=>s+l,0);return a>0?c.map(s=>D(Math.sqrt(s/a))):c.map(()=>-60)}function xt(t){const e=[];for(e.push(t.rt60),e.push(t.edt),e.push(t.c50),e.push(t.c80),e.push(t.spectralCentroid/1e4),e.push(t.spectralRolloff/2e4),e.push(t.spectralFlux),e.push(t.spectralFlatness),e.push(...t.mfccMean),e.push(...t.mfccVariance),e.push(...t.earlyReflections),e.push(...t.octaveBands);e.length<I;)e.push(0);return e.slice(0,I)}function bt(){const[t,e]=S.useState({captureState:"idle",hasPermission:null,error:null,audioLevel:0,lastCapture:null,lastFeatures:null}),n=S.useRef(null);S.useEffect(()=>(X().then(s=>{e(l=>({...l,hasPermission:s}))}),()=>{n.current&&n.current(),Z()}),[]);const r=S.useCallback(async()=>{e(s=>({...s,captureState:"requesting",error:null}));try{return(await C()).getTracks().forEach(l=>l.stop()),e(l=>({...l,captureState:"idle",hasPermission:!0})),!0}catch(s){const l=s instanceof Error?s.message:"Permission denied";return e(u=>({...u,captureState:"error",hasPermission:!1,error:l})),!1}},[]),o=S.useCallback(async s=>{e(l=>({...l,captureState:"capturing",error:null,lastCapture:null,lastFeatures:null}));try{const l=await K(s);e(f=>({...f,captureState:"processing",lastCapture:l}));const u=mt(l),i=At(u);return e(f=>({...f,captureState:"complete",lastFeatures:i})),i}catch(l){const u=l instanceof Error?l.message:"Capture failed";return e(i=>({...i,captureState:"error",error:u})),null}},[]),c=S.useCallback(async()=>{n.current&&n.current();try{const s=await C(),l=await $(s,i=>{e(f=>({...f,audioLevel:i}))}),u=()=>{l(),s.getTracks().forEach(i=>i.stop()),e(i=>({...i,audioLevel:0}))};return n.current=u,u}catch(s){return console.error("Failed to start level monitor:",s),()=>{}}},[]),a=S.useCallback(()=>{e(s=>({...s,captureState:"idle",error:null,lastCapture:null,lastFeatures:null}))},[]);return{state:t,capture:o,requestPermission:r,startLevelMonitor:c,reset:a}}export{bt as u};
//# sourceMappingURL=useAudioEngine-DEbr_Whe.js.map
